<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏–∑–∞ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ë–ü–ò–§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white p-4 mb-4">
            <h1><i class="fas fa-chart-line me-2"></i>–ê–Ω–∞–ª–∏–∑ —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ë–ü–ò–§</h1>
            <p class="mb-0">–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–∏—Ä–∂–µ–≤—ã—Ö –ø–∞–µ–≤—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–æ–Ω–¥–æ–≤</p>
        </header>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 id="total-funds">96</h3>
                        <p>–í—Å–µ–≥–æ —Ñ–æ–Ω–¥–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3 id="total-nav">1,445</h3>
                        <p>–ú–ª—Ä–¥ ‚ÇΩ –°–ß–ê</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 id="avg-return">10.2%</h3>
                        <p>–°—Ä–µ–¥–Ω—è—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h3 id="last-update">–°–µ–≥–æ–¥–Ω—è</h3>
                        <p>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–æ–º</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary me-2" onclick="loadData()">
                            <i class="fas fa-sync me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button class="btn btn-success me-2" onclick="updateAll()">
                            <i class="fas fa-refresh me-1"></i>–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ
                        </button>
                        <button class="btn btn-info me-2" onclick="showArchive()">
                            <i class="fas fa-archive me-1"></i>–ê—Ä—Ö–∏–≤
                        </button>
                        <button class="btn btn-warning" onclick="startScheduler()">
                            <i class="fas fa-clock me-1"></i>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ñ–æ–Ω–¥–æ–≤ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä –¢–æ–ø –ë–ü–ò–§ —Ñ–æ–Ω–¥—ã</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="funds-table">
                                <thead>
                                    <tr>
                                        <th>–¢–∏–∫–µ—Ä</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–°–ß–ê (–º–ª—Ä–¥ ‚ÇΩ)</th>
                                        <th>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th>
                                        <th>–ö–æ–º–∏—Å—Å–∏—è –£–ö</th>
                                        <th>–°—Å—ã–ª–∫–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="funds-tbody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìà –ì—Ä–∞—Ñ–∏–∫ —Ä–∏—Å–∫-–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</h5>
                    </div>
                    <div class="card-body">
                        <div id="risk-return-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="status-area" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –Ω–∞—á–∞–ª–∞.
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:5005'; // API —Å–µ—Ä–≤–µ—Ä
        
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('status-area');
            statusArea.className = `alert alert-${type}`;
            statusArea.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'danger' ? 'times' : 'info'}-circle me-2"></i>${message}`;
        }

        async function loadData() {
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsResponse = await fetch(`${API_BASE}/api/stats`);
                const stats = await statsResponse.json();
                
                document.getElementById('total-funds').textContent = stats.total_etfs || '96';
                document.getElementById('total-nav').textContent = `${(stats.total_nav || 1445).toFixed(0)}`;
                document.getElementById('avg-return').textContent = `${(stats.avg_return || 10.2).toFixed(1)}%`;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                const tableResponse = await fetch(`${API_BASE}/api/table?limit=20`);
                const tableData = await tableResponse.json();
                
                const tbody = document.getElementById('funds-tbody');
                tbody.innerHTML = '';
                
                tableData.data.forEach(fund => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${fund.ticker}</strong></td>
                        <td>${fund.name}</td>
                        <td>${fund.nav_billions.toFixed(1)}</td>
                        <td><span class="badge bg-${fund.annual_return > 10 ? 'success' : 'warning'}">${fund.annual_return.toFixed(1)}%</span></td>
                        <td>${fund.mgmt_fee.toFixed(2)}%</td>
                        <td><a href="${fund.investfunds_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-external-link-alt"></i></a></td>
                    `;
                    tbody.appendChild(row);
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
                const chartResponse = await fetch(`${API_BASE}/api/chart`);
                const chartData = await chartResponse.json();
                
                Plotly.newPlot('risk-return-chart', chartData.data, chartData.layout, {responsive: true});
                
                showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'danger');
            }
        }

        async function updateAll() {
            showStatus('–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...', 'warning');
            
            try {
                const response = await fetch(`${API_BASE}/api/force-refresh`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showStatus(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${result.message}`, 'danger');
                }
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'danger');
            }
        }

        async function showArchive() {
            try {
                const response = await fetch(`${API_BASE}/api/archive-summary`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const summary = result.archive_summary;
                    showStatus(`üì¶ –ê—Ä—Ö–∏–≤: ${summary.archives} –ø–∞–ø–æ–∫, ${summary.funds} —Ñ–æ–Ω–¥–æ–≤, ${summary.total_files} —Ñ–∞–π–ª–æ–≤`, 'info');
                } else {
                    showStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞', 'danger');
                }
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞: ${error.message}`, 'danger');
            }
        }

        async function startScheduler() {
            try {
                const response = await fetch(`${API_BASE}/api/scheduler/start`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω! –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 10:00', 'success');
                } else {
                    showStatus(`–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: ${result.message}`, 'info');
                }
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: ${error.message}`, 'danger');
            }
        }

        // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadData, 1000);
        });
    </script>
</body>
</html>